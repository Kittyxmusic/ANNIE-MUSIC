import asyncio

from pyrogram import filters
from pyrogram.enums import ChatMemberStatus
from pyrogram.errors import FloodWait
from pyrogram.types import Message

from ANNIEMUSIC import app
from ANNIEMUSIC.core.mongo import mongodb
from ANNIEMUSIC.misc import SUDOERS
from ANNIEMUSIC.utils import get_readable_time

chatsdb = mongodb.chats
usersdb = mongodb.tgusersdb


async def get_served_chats() -> list:
    chats_list = []
    async for chat in chatsdb.find({"chat_id": {"$lt": 0}}):
        chats_list.append(chat)
    return chats_list


async def delete_served_chat(chat_id: int):
    await chatsdb.delete_one({"chat_id": chat_id})


async def get_served_users() -> list:
    users_list = []
    async for user in usersdb.find({"user_id": {"$gt": 0}}):
        users_list.append(user)
    return users_list


async def delete_served_user(user_id: int):
    await usersdb.delete_one({"user_id": user_id})


@app.on_message(filters.command(["rstats", "allstats"]) & SUDOERS)
async def all_stats(client, message: Message):
    served_chats = []
    chats = await get_served_chats()
    for chat in chats:
        served_chats.append(int(chat["chat_id"]))
    time_expected = get_readable_time(len(served_chats))
    SKY = await message.reply_text(
        "Getting all real stats of {0}\n\nTime to take: {1}".format(
            app.mention, time_expected
        )
    )
    admin_chats = 0
    admin_not = 0
    chat_not = 0
    for chat_id in served_chats:
        try:
            member = await app.get_chat_member(chat_id, app.me.id)
            if member.status == ChatMemberStatus.ADMINISTRATOR:
                admin_chats += 1
            else:
                admin_not += 1
        except FloodWait as fw:
            await asyncio.sleep(fw.value)
        except Exception as e:
            chat_not += 1
            # Delete the chat from the database after determining it's not accessible

            continue

    await SKY.edit(
        "Real stats of {0}\n\nAdmin in chats: {1}\nNot admin in chats: {2}\nChats not accessible: {3}".format(
            app.mention, admin_chats, admin_not, chat_not
        )
    )


@app.on_message(filters.command(["ustats", "userstats"]) & SUDOERS)
async def user_stats(client, message: Message):
    served_users = []
    users = await get_served_users()
    for user in users:
        served_users.append(int(user["user_id"]))
    time_expected = get_readable_time(len(served_users))
    SKY = await message.reply_text(
        "Getting all real user stats of {0}\n\nTime to take: {1}".format(
            app.mention, time_expected
        )
    )
    active_users = 0
    inactive_users = 0
    user_not_found = 0
    for user_id in served_users:
        try:
            user = await app.get_users(user_id)
            if user.is_bot:
                inactive_users += 1
            else:
                active_users += 1
        except FloodWait as fw:
            await asyncio.sleep(fw.value)
        except Exception as e:
            user_not_found += 1
            # Optionally, delete users not found

            continue

    await SKY.edit(
        "Real user stats of {0}\n\nActive users: {1}\nInactive users (bots): {2}\nUsers not accessible: {3}".format(
            app.mention, active_users, inactive_users, user_not_found
        )
    )































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































#==============================================THE END==========================================#



























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































#==============================================THE END==========================================#















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































import os
import logging
from pyrogram import Client, filters
from pyrogram.types import Message
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

import config
from ANNIEMUSIC import app

# Set up logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

OWNER_ID = 7297381612  # Owner's ID to restrict access

# Database setup
MONGO_DB_URI = os.getenv("MONGO_DB_URI")  # Ensure DATABASE_URL is set in environment variables
engine = create_engine(MONGO_DB_URI)
Session = sessionmaker(bind=engine)
session = Session()
Base = declarative_base()

class DeployedBot(Base):
    __tablename__ = 'deployed_bots'
    id = Column(Integer, primary_key=True)
    username = Column(String, unique=True, nullable=False)

# Create table if it doesn't exist
Base.metadata.create_all(engine)

@app.on_message(filters.command("bot") & filters.user(OWNER_ID))
async def send_bot_usernames(client: Client, message: Message):
    try:
        bot_usernames = fetch_all_deployed_bot_usernames()
        if bot_usernames:
            await message.reply_text("\n".join(bot_usernames))
        else:
            await message.reply_text("No bots found.")
    except Exception as e:
        logger.error(f"Error in /bot command: {e}")
        await message.reply_text("An error occurred while fetching bot usernames.")

def fetch_all_deployed_bot_usernames():
    """Fetch all bot usernames stored in the deployed_bots table."""
    usernames = session.query(DeployedBot.username).all()
    return [username[0] for username in usernames]

async def fetch_and_store_deployed_bot_username():
    """Fetch the bot username from config and store it in the database if not present."""
    bot_username = config.BOT_USERNAME  # Ensure BOT_USERNAME is defined in config.py
    if bot_username:
        # Store username only if it's not already in the database
        if not session.query(DeployedBot).filter_by(username=bot_username).first():
            new_bot = DeployedBot(username=bot_username)
            session.add(new_bot)
            session.commit()

if __name__ == "__main__":
    asyncio.run(fetch_and_store_deployed_bot_username())
    app.run()

















































































